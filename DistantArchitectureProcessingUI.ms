-- è¿œæ™¯å»ºç­‘å¤„ç†å·¥å…· UIç•Œé¢
-- Distant Architecture Processing Tool UI
-- åŸºäº3dsMaxæ¨¡å‹åˆ‡å‰²å¯¹é½æ’ä»¶é¡¹ç›®æ–‡æ¡£è®¾è®¡

try(destroyDialog DistantArchitectureUI) catch()

-- å®šä¹‰æ—¶é—´ä¼°è®¡ç»“æ„ä½“
struct TimeEstimateStruct (
    totalFaces = 0,
    estimatedElements = 0,
    estimatedTimeSeconds = 0.0
)

-- è·å–å¤šè¾¹å½¢å¯¹è±¡ä¸­çš„å®é™…å…ƒç´ æ•°é‡
function getActualElementCount polyObject = (
    local numFaces = polyObject.numfaces
    if numFaces == 0 then return 0
    
    try (
        -- åˆ›å»ºé¢BitArray
        local faceStatus = #{1..numFaces}
        local elementCount = 0
        
        -- æŸ¥æ‰¾æ‰€æœ‰è¿æ¥çš„å…ƒç´ 
        while faceStatus.numberSet > 0 do (
            local firstFace = (for i = 1 to numFaces where faceStatus[i] collect i)[1]
            local connectedFaces = polyop.getElementsUsingFace polyObject #{firstFace}
            elementCount += 1
            
            -- ä»faceStatusä¸­åˆ é™¤å·²å¤„ç†çš„é¢
            faceStatus = faceStatus - connectedFaces
        )
        
        return elementCount
    ) catch (
        -- å¦‚æœå‡ºç°é”™è¯¯ï¼Œè¿”å›1ä½œä¸ºé»˜è®¤å€¼
        format "è·å–å…ƒç´ æ•°é‡å‡ºé”™: %\n" (getCurrentException())
        return 1
    )
)

-- ä¼°ç®—æ¨¡å‹å¤„ç†æ—¶é—´å‡½æ•°
function estimateProcessingTime sourceModels = (
    local totalFaces = 0
    local totalVertices = 0
    local actualElementCount = 0
    local baseTimePerFace = 0.025 -- æ¯ä¸ªé¢çš„åŸºç¡€å¤„ç†æ—¶é—´(ç§’)ï¼Œ25æ¯«ç§’/é¢
    local baseTimePerElement = 0.5 -- æ¯ä¸ªå…ƒç´ çš„åŸºç¡€å¤„ç†æ—¶é—´(ç§’)ï¼Œé™ä½ä¸º0.5ç§’/å…ƒç´ 
    local minimumTime = 5.0 -- æœ€ä½å¤„ç†æ—¶é—´(ç§’)
    
    -- è®¡ç®—æ€»é¢æ•°å’Œå®é™…å…ƒç´ æ•°
    for obj in sourceModels do (
        if isValidNode obj then (
            -- è½¬æ¢ä¸ºå¯è®¡ç®—çš„å¯¹è±¡ç±»å‹
            local tempObj = copy obj
            convertToPoly tempObj
            
            -- ç»Ÿè®¡é¢æ•°å’Œé¡¶ç‚¹æ•°
            local numFaces = tempObj.numfaces
            local numVerts = tempObj.numverts
            totalFaces += numFaces
            totalVertices += numVerts
            
            -- è·å–å®é™…å…ƒç´ æ•°é‡
            local elemCount = getActualElementCount tempObj
            actualElementCount += elemCount
            
            format "æ¨¡å‹ % åŒ…å« % ä¸ªé¢, % ä¸ªç‚¹, % ä¸ªå…ƒç´ \n" obj.name numFaces numVerts elemCount
            
            -- é‡Šæ”¾ä¸´æ—¶å¯¹è±¡
            delete tempObj
        )
    )
    
    -- ç¡®ä¿è‡³å°‘æœ‰1ä¸ªå…ƒç´ 
    actualElementCount = amax #(actualElementCount, 1)
    
    -- è®¡ç®—ä¼°è®¡æ—¶é—´(ç§’)
    local estimatedTime = (totalFaces * baseTimePerFace) + (actualElementCount * baseTimePerElement)
    
    -- è€ƒè™‘ç³»ç»Ÿæ€§èƒ½å› ç´ 
    local systemFactor = 1.0
    -- å¦‚æœå†…å­˜ä¸è¶³ï¼Œå¢åŠ æ—¶é—´ä¼°è®¡
    if heapSize < 200000000 then systemFactor = 2.0
    
    local finalEstimatedTime = estimatedTime * systemFactor
    
    -- ç¡®ä¿æœ€ä½å¤„ç†æ—¶é—´
    finalEstimatedTime = amax #(finalEstimatedTime, minimumTime)
    
    format "è°ƒè¯•: é¢æ•°=%ï¼Œå®é™…å…ƒç´ æ•°=%ï¼ŒåŸå§‹æ—¶é—´=%ç§’ï¼Œæœ€ç»ˆæ—¶é—´=%ç§’\n" totalFaces actualElementCount estimatedTime finalEstimatedTime
    
    -- ç”Ÿæˆæè¿°æ€§çš„ç»“æœï¼Œä½¿ç”¨ç»“æ„ä½“ä»£æ›¿æ•°ç»„
    local resultStruct = TimeEstimateStruct()
    resultStruct.totalFaces = totalFaces
    resultStruct.estimatedElements = actualElementCount
    resultStruct.estimatedTimeSeconds = finalEstimatedTime
    
    return resultStruct
)

-- æ˜¾ç¤ºæ—¶é—´çš„è¾…åŠ©å‡½æ•°
function formatTimeString seconds = (
    if seconds < 60 then (
        return (seconds as integer) as string + " ç§’"
    )
    else if seconds < 3600 then (
        local mins = (seconds / 60) as integer
        local secs = mod seconds 60
        return mins as string + " åˆ† " + secs as string + " ç§’"
    )
    else (
        local hrs = (seconds / 3600) as integer
        local mins = (mod seconds 3600) / 60 as integer
        return hrs as string + " å°æ—¶ " + mins as string + " åˆ†é’Ÿ"
    )
)

-- ä¼˜åŒ–çš„æ ¸å¿ƒæ‹†è§£å‡½æ•° - é«˜æ•ˆå…ƒç´ åˆ†ç¦»ç®—æ³•
function decomposeModel sourceModel timeEstimate:(TimeEstimateStruct totalFaces:0 estimatedElements:1 estimatedTimeSeconds:30.0) = (
    local elements = #()
    local startTime = timeStamp()
    
    -- å†…å­˜å’Œæ€§èƒ½æ£€æŸ¥
    if heapSize < 100000000 then (
        messageBox "è­¦å‘Šï¼šå¯ç”¨å†…å­˜ä¸è¶³ï¼Œå»ºè®®é‡Šæ”¾å†…å­˜åé‡è¯•"
        return #()
    )
    
    -- ç¡®ä¿æºæ¨¡å‹æ˜¯å¯ç¼–è¾‘ç½‘æ ¼æˆ–å¤šè¾¹å½¢
    if classof sourceModel != Editable_mesh and classof sourceModel != Editable_Poly then (
        -- å¦‚æœä¸æ˜¯ç½‘æ ¼å¯¹è±¡ï¼Œå°è¯•è½¬æ¢
        addModifier sourceModel (Edit_Poly())
    )
    
    -- è½¬æ¢ä¸ºEditable_Poly
    convertToPoly sourceModel
    
    local numFaces = sourceModel.numfaces
    
    -- å¤§æ¨¡å‹é¢„æ£€æŸ¥
    if numFaces > 50000 then (
        local result = queryBox ("æ¨¡å‹åŒ…å« " + numFaces as string + " ä¸ªé¢ï¼Œå¤„ç†å¯èƒ½è¾ƒæ…¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ")
        if not result then return #()
    )
    
    try (
        -- è·å–æ‰€æœ‰å…ƒç´ 
        local elementsArray = #()
        local faceStatus = #{1..numFaces} -- åˆ›å»ºåŒ…å«æ‰€æœ‰é¢çš„BitArray
        
        -- æŸ¥æ‰¾è¿æ¥çš„å…ƒç´ 
        while faceStatus.numberSet > 0 do (
            local firstFace = (for i = 1 to numFaces where faceStatus[i] collect i)[1]
            local connectedFaces = polyop.getElementsUsingFace sourceModel #{firstFace}
            append elementsArray connectedFaces
            
            -- ä»faceStatusä¸­åˆ é™¤å·²å¤„ç†çš„é¢
            faceStatus = faceStatus - connectedFaces
        )
        
        local elementCount = elementsArray.count
        format "æ‰¾åˆ° % ä¸ªç‹¬ç«‹å…ƒç´ \n" elementCount
        
        -- åˆ†æ‰¹å¤„ç†å…ƒç´ 
        local batchSize = 10
        local processedCount = 0
        
        for i = 1 to elementCount by batchSize do (
            local endIndex = amin #(i + batchSize - 1, elementCount)
            
            -- å¤„ç†å½“å‰æ‰¹æ¬¡
            for j = i to endIndex do (
                if j <= elementsArray.count then (
                    local elementFaces = elementsArray[j]
                    
                    if elementFaces.numberSet > 0 then (
                        -- åˆ›å»ºæ–°å…ƒç´ 
                        local newElement = copy sourceModel
                        convertToPoly newElement
                        
                        -- åˆ é™¤éå½“å‰å…ƒç´ çš„é¢
                        local facesToDelete = #{1..newElement.numfaces} - elementFaces
                        if facesToDelete.numberSet > 0 then (
                            polyop.deleteFaces newElement facesToDelete
                        )
                        
                        -- æ¸…ç†å­¤ç«‹é¡¶ç‚¹
                        polyop.deleteIsoVerts newElement
                        
                        -- å‘½åæ–°å…ƒç´ ï¼Œä½¿ç”¨ä¸‰ä½æ•°åºå·æ ¼å¼
                        local formattedIndex = formattedPrint j format:"03d"
                        newElement.name = sourceModel.name + "_" + formattedIndex
                        
                        -- éªŒè¯å…ƒç´ æœ‰æ•ˆæ€§
                        if newElement.numfaces > 0 then (
                            append elements newElement
                            processedCount += 1
                        ) else (
                            delete newElement
                        )
                    )
                )
            )
            
            -- å†…å­˜ç®¡ç†
            gc()
            
            -- è¿›åº¦æ›´æ–°å’Œç”¨æˆ·å“åº”
            windows.processPostedMessages()
            
            -- è¶…æ—¶æ£€æŸ¥ï¼ˆåŸºäºä¼°è®¡æ—¶é—´åŠ¨æ€è°ƒæ•´ï¼‰
            local timeoutMs = (timeEstimate.estimatedTimeSeconds + 60) * 1000 -- é¢„è®¡æ—¶é—´åŠ 1åˆ†é’Ÿï¼ˆæ¯«ç§’ï¼‰
            if (timeStamp() - startTime) > timeoutMs then (
                messageBox "å¤„ç†è¶…æ—¶ï¼Œå·²åœæ­¢ã€‚å·²å¤„ç†å…ƒç´ æ•°ï¼š" + processedCount as string
                exit
            )
        )
        
        -- æ¸…é™¤æºæ¨¡å‹çš„é€‰æ‹©
        try(sourceModel.selectedFaces = #{}) catch()
        
        format "æˆåŠŸåˆ†ç¦» % ä¸ªå…ƒç´ ï¼Œè€—æ—¶ % æ¯«ç§’\n" elements.count (timeStamp() - startTime)
    )
    catch (
        local errorMsg = "åˆ†ç¦»æ¨¡å‹æ—¶å‡ºé”™: " + (getCurrentException())
        format "%\n" errorMsg
        messageBox errorMsg title:"é”™è¯¯"
        return #()
    )
    
    return elements
)

rollout DistantArchitectureUI "ğŸ—ï¸ è¿œæ™¯å»ºç­‘å¤„ç†å·¥å…· v2.0" width:520 height:620
(
    -- å…¨å±€å˜é‡
    local buildingQueue = #()
    local terrainQueue = #()
    local isProcessing = false
    local logText = ""
    
    -- é¡¶éƒ¨æŒ‰é’®åŒºåŸŸ
    groupBox grpModelGet "ğŸ“¦ æ¨¡å‹è·å–" width:480 height:70 pos:[20,15]
    
    button btnGetBuilding "ğŸ¢ è·å–å»ºç­‘æ¨¡å‹" width:140 height:30 pos:[60,35] color:[100,150,255] across:2
    button btnGetTerrain "ğŸŒ è·å–åœ°å½¢æ¨¡å‹" width:140 height:30 pos:[300,35] color:[100,200,100]
    

    -- é˜Ÿåˆ—æ˜¾ç¤ºåŒºåŸŸ
    groupBox grpQueueManage "ğŸ“‹ é˜Ÿåˆ—ç®¡ç†" width:480 height:170 pos:[20,90]
    
    label lblBuildingQueue "ğŸ¢ å»ºç­‘æ¨¡å‹é˜Ÿåˆ—" pos:[70,110] height:20
    label lblTerrainQueue "ğŸŒ åœ°å½¢æ¨¡å‹é˜Ÿåˆ—" pos:[310,110] height:20
        
    -- å»ºç­‘æ¨¡å‹é˜Ÿåˆ—åˆ—è¡¨
    listbox lstBuildingQueue "" pos:[50,130] width:140 height:6 scrollbars:true
        
    -- åœ°å½¢é˜Ÿåˆ—åˆ—è¡¨
    listbox lstTerrainQueue "" pos:[300,130] width:140 height:6 scrollbars:true
        
    -- å»ºç­‘é˜Ÿåˆ—æ“ä½œæŒ‰é’®
    button btnAddBuilding "â• æ·»åŠ  " width:50 height:25 pos:[40,230] color:[120,180,255] across:6
    button btnDelBuilding "â– åˆ é™¤ " width:50 height:25 pos:[100,230] color:[255,120,120]
    button btnClearBuilding "ğŸ—‘ï¸ æ¸…ç©º " width:50 height:25 pos:[160,230] color:[255,180,100]
        
    -- åœ°å½¢é˜Ÿåˆ—æ“ä½œæŒ‰é’®
    button btnAddTerrain "â• æ·»åŠ  " width:50 height:25 pos:[280,230] color:[120,180,255]
    button btnDelTerrain "â– åˆ é™¤ " width:50 height:25 pos:[340,230] color:[255,120,120] 
    button btnClearTerrain "ğŸ—‘ï¸ æ¸…ç©º " width:50 height:25 pos:[400,230] color:[255,180,100] 
    

    -- ç‹¬ç«‹æ‰§è¡ŒåŠŸèƒ½åŒºåŸŸ
    groupBox grpIndependentExec "âš™ï¸ ç‹¬ç«‹æ‰§è¡Œ" width:480 height:75 pos:[20,270]
    
    button btnSeparateModel "âœ‚ï¸ åˆ†ç¦»æ¨¡å‹" width:120 height:35 pos:[50,300] color:[255,200,100] across:3
    button btnAlignGround "ğŸ“ å¯¹é½åœ°é¢" width:120 height:35 pos:[200,300] color:[150,255,150]
    button btnMergeModel "ğŸ”— åˆå¹¶æ¨¡å‹" width:120 height:35 pos:[350,300] color:[255,150,255]
    

    -- è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ
    groupBox grpProcessStatus "ğŸ“Š å¤„ç†çŠ¶æ€" width:480 height:70 pos:[20,355]
    
    label lblStatus "âš¡ çŠ¶æ€: å‡†å¤‡å°±ç»ª" pos:[200,380] 
    progressbar pgbProgress "" pos:[45,400] width:450 height:20 color:[50,200,50]
    
    
    -- è¿è¡Œæ—¥å¿—åŒºåŸŸ
    groupBox grpRunLog "ğŸ“ è¿è¡Œæ—¥å¿—" width:480 height:130 pos:[20,430]
    
    dotNetControl edtLog "System.Windows.Forms.RichTextBox" pos:[30,455] width:450 height:95
    

    
    
    -- ä¸€é”®å¤„ç†æŒ‰é’®
    button btnOneClickProcess "ğŸš€ ä¸€é”®å¤„ç†" width:150 height:40 pos:[185,565] color:[255,100,100] style_sunkenedge:true
    
    
    
    -- è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ æ—¥å¿—ï¼ˆæœ€æ–°æ•°æ®æ˜¾ç¤ºåœ¨å‰é¢ï¼‰
    function addLog message = 
    (
        local timeStamp = localTime
        local logEntry = "[" + timeStamp as string + "] " + message + "\r\n"
        -- å°†æ–°æ—¥å¿—æ·»åŠ åˆ°å¼€å¤´è€Œä¸æ˜¯æœ«å°¾
        logText = logEntry + logText
        edtLog.Text = logText
        -- RichTextBoxæ”¯æŒè‡ªåŠ¨æ»šåŠ¨ï¼Œä½†ç”±äºæ–°å†…å®¹åœ¨é¡¶éƒ¨ï¼Œä¸éœ€è¦æ»šåŠ¨
        windows.processPostedMessages()
    )
    
    -- è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è¿›åº¦æ¡
    function updateProgress value = 
    (
        pgbProgress.value = value
        windows.processPostedMessages()
    )
    
    -- è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°çŠ¶æ€
    function updateStatus status = 
    (
        lblStatus.text = "çŠ¶æ€: " + status
        addLog status
    )
    
    -- è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°å»ºç­‘é˜Ÿåˆ—æ˜¾ç¤º
    function updateBuildingQueueDisplay = 
    (
        local displayNames = #()
        for obj in buildingQueue do
        (
            if isValidNode obj then
                append displayNames obj.name
            else
                append displayNames "<æ— æ•ˆå¯¹è±¡>"
        )
        lstBuildingQueue.items = displayNames
    )
    
    -- è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°åœ°å½¢é˜Ÿåˆ—æ˜¾ç¤º
    function updateTerrainQueueDisplay = 
    (
        local displayNames = #()
        for obj in terrainQueue do
        (
            if isValidNode obj then
                append displayNames obj.name
            else
                append displayNames "<æ— æ•ˆå¯¹è±¡>"
        )
        lstTerrainQueue.items = displayNames
    )
    
    -- è·å–å»ºç­‘æ¨¡å‹æŒ‰é’®äº‹ä»¶
    on btnGetBuilding pressed do
    (
        addLog "æ‰“å¼€å¯¹è±¡é€‰æ‹©å¯¹è¯æ¡†..."
        
        try
        (
            -- ä½¿ç”¨3dsMaxåŸç”Ÿçš„selectByNameå¯¹è¯æ¡†
            -- è¿™ä¼šæ‰“å¼€ä¸€ä¸ªç±»ä¼¼å›¾ç‰‡ä¸­çš„å¯¹è±¡é€‰æ‹©ç•Œé¢
            local selectedObjects = selectByName title:"é€‰æ‹©å»ºç­‘æ¨¡å‹" buttonText:"ç¡®å®š" showHidden:false single:false
            
            if selectedObjects != undefined and selectedObjects.count > 0 then
             (
                 -- ç›´æ¥å°†é€‰ä¸­çš„å¯¹è±¡æ·»åŠ åˆ°å»ºç­‘é˜Ÿåˆ—
                 local addedCount = 0
                 for obj in selectedObjects do
                 (
                     if findItem buildingQueue obj == 0 then
                     (
                         append buildingQueue obj
                         addLog ("æ·»åŠ å»ºç­‘æ¨¡å‹: " + obj.name)
                         addedCount += 1
                     )
                     else
                     (
                         addLog ("å»ºç­‘æ¨¡å‹å·²å­˜åœ¨ï¼Œè·³è¿‡: " + obj.name)
                     )
                 )
                 
                 -- æ›´æ–°å»ºç­‘é˜Ÿåˆ—æ˜¾ç¤º
                 updateBuildingQueueDisplay()
                 
                 -- é€‰æ‹©è¿™äº›å¯¹è±¡ä»¥ä¾¿ç”¨æˆ·æŸ¥çœ‹
                 clearSelection()
                 select selectedObjects
                 
                 -- æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                  if addedCount > 0 then
                  (
                      updateStatus ("æˆåŠŸæ·»åŠ  " + addedCount as string + " ä¸ªå»ºç­‘æ¨¡å‹")
                  )
                  else
                  (
                      updateStatus "æ‰€é€‰å¯¹è±¡éƒ½å·²å­˜åœ¨äºé˜Ÿåˆ—ä¸­"
                  )
             )
            else
            (
                addLog "ç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©æˆ–æœªé€‰æ‹©ä»»ä½•å¯¹è±¡"
                updateStatus "è¯·é‡æ–°é€‰æ‹©å»ºç­‘æ¨¡å‹"
            )
        )
        catch
        (
            addLog "æ‰“å¼€é€‰æ‹©å¯¹è¯æ¡†å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
            
            -- å¤‡ç”¨æ–¹æ¡ˆï¼šæç¤ºç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
            local instructions = "æ— æ³•æ‰“å¼€é€‰æ‹©å¯¹è¯æ¡†ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š\n\n"
            instructions += "æ–¹æ³•1ï¼šæŒ‰å¿«æ·é”® H æ‰“å¼€é€‰æ‹©å¯¹è¯æ¡†\n"
            instructions += "æ–¹æ³•2ï¼šåœ¨è§†å£ä¸­ç›´æ¥é€‰æ‹©å¯¹è±¡\n"
            instructions += "æ–¹æ³•3ï¼šèœå•æ  â†’ Edit â†’ Select By Name\n\n"
            instructions += "é€‰æ‹©å»ºç­‘æ¨¡å‹åï¼Œç‚¹å‡»ä¸‹æ–¹çš„'æ·»åŠ 'æŒ‰é’®"
            
            messageBox instructions title:"æ‰‹åŠ¨æ“ä½œæŒ‡å¯¼" beep:false
            
            updateStatus "è¯·æ‰‹åŠ¨é€‰æ‹©å»ºç­‘æ¨¡å‹åç‚¹å‡»æ·»åŠ æŒ‰é’®"
        )
    )
    
    -- è·å–åœ°å½¢æŒ‰é’®äº‹ä»¶
    on btnGetTerrain pressed do
    (
        addLog "æ‰“å¼€åœ°å½¢æ¨¡å‹é€‰æ‹©å¯¹è¯æ¡†..."
        
        try
        (
            -- ä½¿ç”¨3dsMaxåŸç”Ÿçš„selectByNameå¯¹è¯æ¡†
            -- è¿™ä¼šæ‰“å¼€ä¸€ä¸ªç±»ä¼¼å›¾ç‰‡ä¸­çš„å¯¹è±¡é€‰æ‹©ç•Œé¢
            local selectedObjects = selectByName title:"é€‰æ‹©åœ°å½¢æ¨¡å‹" buttonText:"ç¡®å®š" showHidden:false single:false
            
            if selectedObjects != undefined and selectedObjects.count > 0 then
             (
                 -- ç›´æ¥å°†é€‰ä¸­çš„å¯¹è±¡æ·»åŠ åˆ°åœ°å½¢é˜Ÿåˆ—
                 local addedCount = 0
                 for obj in selectedObjects do
                 (
                     -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äºåœ°å½¢é˜Ÿåˆ—
                     if findItem terrainQueue obj == 0 then
                     (
                         -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äºå»ºç­‘é˜Ÿåˆ—
                         if findItem buildingQueue obj == 0 then
                         (
                             append terrainQueue obj
                             addLog ("æ·»åŠ åœ°å½¢æ¨¡å‹: " + obj.name)
                             addedCount += 1
                         )
                         else
                         (
                             addLog ("æ¨¡å‹å·²å­˜åœ¨äºå»ºç­‘é˜Ÿåˆ—ä¸­ï¼Œè·³è¿‡: " + obj.name)
                         )
                     )
                     else
                     (
                         addLog ("åœ°å½¢æ¨¡å‹å·²å­˜åœ¨ï¼Œè·³è¿‡: " + obj.name)
                     )
                 )
                 
                 -- æ›´æ–°åœ°å½¢é˜Ÿåˆ—æ˜¾ç¤º
                 updateTerrainQueueDisplay()
                 
                 -- é€‰æ‹©è¿™äº›å¯¹è±¡ä»¥ä¾¿ç”¨æˆ·æŸ¥çœ‹
                 clearSelection()
                 select selectedObjects
                 
                 -- æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                  if addedCount > 0 then
                  (
                      updateStatus ("æˆåŠŸæ·»åŠ  " + addedCount as string + " ä¸ªåœ°å½¢æ¨¡å‹")
                  )
                  else
                  (
                      updateStatus "æ‰€é€‰å¯¹è±¡éƒ½å·²å­˜åœ¨äºé˜Ÿåˆ—ä¸­"
                  )
             )
            else
            (
                addLog "ç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©æˆ–æœªé€‰æ‹©ä»»ä½•å¯¹è±¡"
                updateStatus "è¯·é‡æ–°é€‰æ‹©åœ°å½¢æ¨¡å‹"
            )
        )
        catch
        (
            addLog "æ‰“å¼€é€‰æ‹©å¯¹è¯æ¡†å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
            
            -- å¤‡ç”¨æ–¹æ¡ˆï¼šæç¤ºç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
            local instructions = "æ— æ³•æ‰“å¼€é€‰æ‹©å¯¹è¯æ¡†ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š\n\n"
            instructions += "æ–¹æ³•1ï¼šæŒ‰å¿«æ·é”® H æ‰“å¼€é€‰æ‹©å¯¹è¯æ¡†\n"
            instructions += "æ–¹æ³•2ï¼šåœ¨è§†å£ä¸­ç›´æ¥é€‰æ‹©å¯¹è±¡\n"
            instructions += "æ–¹æ³•3ï¼šèœå•æ  â†’ Edit â†’ Select By Name\n\n"
            instructions += "é€‰æ‹©åœ°å½¢æ¨¡å‹åï¼Œç‚¹å‡»ä¸‹æ–¹çš„'æ·»åŠ 'æŒ‰é’®"
            
            messageBox instructions title:"æ‰‹åŠ¨æ“ä½œæŒ‡å¯¼" beep:false
            
            updateStatus "è¯·æ‰‹åŠ¨é€‰æ‹©åœ°å½¢æ¨¡å‹åç‚¹å‡»æ·»åŠ æŒ‰é’®"
        )
    )
    
    -- å»ºç­‘é˜Ÿåˆ—æ“ä½œæŒ‰é’®äº‹ä»¶
    on btnAddBuilding pressed do
    (
        if selection.count > 0 then
        (
            for obj in selection do
            (
                if findItem buildingQueue obj == 0 then
                (
                    append buildingQueue obj
                    addLog ("æ‰‹åŠ¨æ·»åŠ å»ºç­‘æ¨¡å‹: " + obj.name)
                )
            )
            updateBuildingQueueDisplay()
        )
        else
        (
            messageBox "è¯·å…ˆé€‰æ‹©è¦æ·»åŠ çš„å¯¹è±¡" title:"æç¤º"
        )
    )
    
    on btnDelBuilding pressed do
    (
        local selIndex = lstBuildingQueue.selection
        if selIndex > 0 and selIndex <= buildingQueue.count then
        (
            local removedObj = buildingQueue[selIndex]
            deleteItem buildingQueue selIndex
            addLog ("åˆ é™¤å»ºç­‘æ¨¡å‹: " + removedObj.name)
            updateBuildingQueueDisplay()
        )
        else
        (
            messageBox "è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®" title:"æç¤º"
        )
    )
    
    on btnClearBuilding pressed do
    (
        buildingQueue = #()
        updateBuildingQueueDisplay()
        addLog "æ¸…ç©ºå»ºç­‘æ¨¡å‹é˜Ÿåˆ—"
    )
    
    -- åœ°å½¢é˜Ÿåˆ—æ“ä½œæŒ‰é’®äº‹ä»¶
    on btnAddTerrain pressed do
    (
        if selection.count > 0 then
        (
            local addedCount = 0
            for obj in selection do
            (
                -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äºåœ°å½¢é˜Ÿåˆ—
                if findItem terrainQueue obj == 0 then
                (
                    -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äºå»ºç­‘é˜Ÿåˆ—
                    if findItem buildingQueue obj == 0 then
                    (
                        append terrainQueue obj
                        addLog ("æ‰‹åŠ¨æ·»åŠ åœ°å½¢æ¨¡å‹: " + obj.name)
                        addedCount += 1
                    )
                    else
                    (
                        addLog ("æ¨¡å‹å·²å­˜åœ¨äºå»ºç­‘é˜Ÿåˆ—ä¸­ï¼Œè·³è¿‡: " + obj.name)
                    )
                )
                else
                (
                    addLog ("åœ°å½¢æ¨¡å‹å·²å­˜åœ¨ï¼Œè·³è¿‡: " + obj.name)
                )
            )
            updateTerrainQueueDisplay()
            
            -- æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            if addedCount > 0 then
            (
                updateStatus ("æˆåŠŸæ·»åŠ  " + addedCount as string + " ä¸ªåœ°å½¢æ¨¡å‹")
            )
            else
            (
                updateStatus "æ‰€é€‰å¯¹è±¡éƒ½å·²å­˜åœ¨äºé˜Ÿåˆ—ä¸­æˆ–å»ºç­‘é˜Ÿåˆ—ä¸­"
            )
        )
        else
        (
            messageBox "è¯·å…ˆé€‰æ‹©è¦æ·»åŠ çš„å¯¹è±¡" title:"æç¤º"
        )
    )
    
    on btnDelTerrain pressed do
    (
        local selIndex = lstTerrainQueue.selection
        if selIndex > 0 and selIndex <= terrainQueue.count then
        (
            local removedObj = terrainQueue[selIndex]
            deleteItem terrainQueue selIndex
            addLog ("åˆ é™¤åœ°å½¢æ¨¡å‹: " + removedObj.name)
            updateTerrainQueueDisplay()
        )
        else
        (
            messageBox "è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®" title:"æç¤º"
        )
    )
    
    on btnClearTerrain pressed do
    (
        terrainQueue = #()
        updateTerrainQueueDisplay()
        addLog "æ¸…ç©ºåœ°å½¢æ¨¡å‹é˜Ÿåˆ—"
    )
    
    -- ç‹¬ç«‹æ‰§è¡ŒåŠŸèƒ½æŒ‰é’®äº‹ä»¶
    on btnSeparateModel pressed do
    (
        if buildingQueue.count == 0 then
        (
            messageBox "å»ºç­‘æ¨¡å‹é˜Ÿåˆ—ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å»ºç­‘æ¨¡å‹" title:"è­¦å‘Š"
            return()
        )
        
        -- ä¼°ç®—å¤„ç†æ—¶é—´
        updateStatus "æ­£åœ¨ä¼°ç®—å¤„ç†æ—¶é—´..."
        local timeEstimate = estimateProcessingTime buildingQueue
        local timeString = formatTimeString timeEstimate.estimatedTimeSeconds
        
        -- æ˜¾ç¤ºä¼°ç®—ä¿¡æ¯å¹¶è¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­
        local infoMsg = "æ¨¡å‹ç»Ÿè®¡:\n"
        infoMsg += "- æ€»é¢æ•°: " + timeEstimate.totalFaces as string + "\n"
        infoMsg += "- å®é™…å…ƒç´ æ•°: " + timeEstimate.estimatedElements as string + "\n"
        infoMsg += "- é¢„è®¡å¤„ç†æ—¶é—´: " + timeString + "\n\n"
        infoMsg += "æ˜¯å¦ç»§ç»­å¤„ç†?"
        
        local continueProcessing = queryBox infoMsg title:"å¤„ç†æ—¶é—´ä¼°ç®—"
        if not continueProcessing then (
            updateStatus "ç”¨æˆ·å–æ¶ˆäº†å¤„ç†"
            return()
        )
        
        updateStatus "å¼€å§‹åˆ†ç¦»æ¨¡å‹..."
        updateProgress 0
        
        addLog "æ‰§è¡Œæ¨¡å‹åˆ†ç¦»åŠŸèƒ½ - å¯¹æ¨¡å‹é˜Ÿåˆ—ä¸­çš„æ¨¡å‹è¿›è¡ŒæŒ‰å…ƒç´ å±‚çº§åˆ†ç¦»"
        addLog ("é¢„è®¡å¤„ç†æ—¶é—´: " + timeString + ", å®é™…å…ƒç´ æ•°: " + timeEstimate.estimatedElements as string)
        
        -- å¤„ç†æ¯ä¸ªæ¨¡å‹å¹¶è®°å½•åˆ†ç¦»åçš„å…ƒç´ 
        local allSeparatedElements = #()
        local totalProcessed = 0
        local totalElements = 0
        
        for i = 1 to buildingQueue.count do
        (
            local obj = buildingQueue[i]
            if isValidNode obj then
            (
                local objName = obj.name
                
                -- æ­¥éª¤1: å…ˆä¸ºæ¨¡å‹åˆ›å»ºåŒåå±‚å¹¶å°†åŸå§‹æ¨¡å‹æ·»åŠ åˆ°å±‚ä¸­
                addLog ("æ­£åœ¨ä¸ºæ¨¡å‹ " + objName + " åˆ›å»ºå±‚...")
                try (
                    -- åˆ›å»ºä¸æ¨¡å‹åŒåçš„å±‚
                    local modelLayer
                    if (layerManager.getLayerFromName objName) == undefined then
                    (
                        modelLayer = layerManager.newLayerFromName objName
                    )
                    else
                    (
                        modelLayer = layerManager.getLayerFromName objName
                    )
                    
                    -- å°†åŸå§‹æ¨¡å‹æ·»åŠ åˆ°å±‚ä¸­
                    modelLayer.addNode obj
                    
                    addLog ("å·²å°†æ¨¡å‹ " + objName + " æ·»åŠ åˆ°åŒåå±‚ä¸­")
                ) catch (
                    addLog ("åˆ›å»ºå±‚æˆ–æ·»åŠ æ¨¡å‹åˆ°å±‚æ—¶å‡ºé”™: " + (getCurrentException()))
                )
                
                -- æ­¥éª¤2: åœ¨å±‚å†…åˆ†ç¦»æ¨¡å‹
                addLog ("æ­£åœ¨åˆ†ç¦»æ¨¡å‹: " + objName)
                updateProgress (i as float / buildingQueue.count * 50) -- å‰50%è¿›åº¦ç”¨äºåˆ†ç¦»
                
                -- è°ƒç”¨å®é™…çš„åˆ†ç¦»å‡½æ•°ï¼Œä¼ é€’æ—¶é—´ä¼°è®¡å‚æ•°
                local separatedElements = decomposeModel obj timeEstimate:timeEstimate
                
                -- è®°å½•åˆ†ç¦»ç»“æœ
                if separatedElements.count > 0 then
                (
                    addLog ("æˆåŠŸä»æ¨¡å‹ " + objName + " åˆ†ç¦»å‡º " + separatedElements.count as string + " ä¸ªå…ƒç´ ")
                    totalElements += separatedElements.count
                    
                    -- å°†åˆ†ç¦»çš„å…ƒç´ æ·»åŠ åˆ°æ€»å…ƒç´ åˆ—è¡¨ä¸­
                    join allSeparatedElements separatedElements
                    
                    -- ç¡®ä¿æ‰€æœ‰åˆ†ç¦»å…ƒç´ éƒ½åœ¨æ­£ç¡®çš„å±‚ä¸­
                    try (
                        -- è·å–å·²åˆ›å»ºçš„å±‚å¼•ç”¨
                        local modelLayer = layerManager.getLayerFromName objName
                        if modelLayer != undefined then
                        (
                            -- ä¸€æ¬¡æ€§æ‰¹é‡æ·»åŠ æ‰€æœ‰å…ƒç´ åˆ°å±‚
                            for elem in separatedElements do
                            (
                                modelLayer.addNode elem
                            )
                            
                            addLog ("å·²å°† " + separatedElements.count as string + " ä¸ªå…ƒç´ æ·»åŠ åˆ°å±‚ " + objName)
                        )
                        else
                        (
                            addLog ("è­¦å‘Š: æœªæ‰¾åˆ°å±‚ '" + objName + "', æ— æ³•æ·»åŠ åˆ†ç¦»å…ƒç´ ")
                        )
                    ) catch (
                        addLog ("å°†åˆ†ç¦»å…ƒç´ æ·»åŠ åˆ°å±‚æ—¶å‡ºé”™: " + (getCurrentException()))
                    )
                )
                else
                (
                    addLog ("åˆ†ç¦»æ¨¡å‹ " + objName + " å¤±è´¥æˆ–æœªæ‰¾åˆ°å¯åˆ†ç¦»å…ƒç´ ")
                )
                
                totalProcessed += 1
                updateProgress (50 + (totalProcessed as float / buildingQueue.count * 50)) -- å50%ç”¨äºå®ŒæˆçŠ¶æ€
            )
            windows.processPostedMessages()
        )
        
        -- å®Œæˆåˆ†ç¦»å¤„ç†
        updateProgress 100
        
        if totalElements > 0 then
        (
            -- åˆ†ç¦»å’Œå±‚ç®¡ç†å·²åœ¨å‰é¢çš„å¾ªç¯ä¸­å®Œæˆï¼Œè¿™é‡Œåªéœ€è¦æ±‡æ€»ç»“æœ
            
            -- é€‰æ‹©æ‰€æœ‰åˆ†ç¦»å‡ºçš„å…ƒç´ ä»¥ä¾¿æŸ¥çœ‹
            clearSelection()
            select allSeparatedElements
            
            updateStatus ("æ¨¡å‹åˆ†ç¦»å®Œæˆï¼Œå…±åˆ†ç¦»å‡º " + totalElements as string + " ä¸ªå…ƒç´ ")
            addLog ("===== å®Œæˆåˆ†ç¦» " + buildingQueue.count as string + " ä¸ªæ¨¡å‹ï¼Œå…±ç”Ÿæˆ " + totalElements as string + " ä¸ªå…ƒç´  =====")
        )
        else
        (
            updateStatus "æ¨¡å‹åˆ†ç¦»å®Œæˆï¼Œä½†æœªç”Ÿæˆä»»ä½•å…ƒç´ "
            addLog "===== åˆ†ç¦»æ“ä½œå®Œæˆï¼Œä½†æœªç”Ÿæˆä»»ä½•å…ƒç´  ====="
        )
    )
    
    on btnAlignGround pressed do
    (
        if buildingQueue.count == 0 then
        (
            messageBox "å»ºç­‘æ¨¡å‹é˜Ÿåˆ—ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å»ºç­‘æ¨¡å‹" title:"è­¦å‘Š"
            return()
        )
        
        if terrainQueue.count == 0 then
        (
            messageBox "åœ°å½¢é˜Ÿåˆ—ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ åœ°å½¢æ¨¡å‹" title:"è­¦å‘Š"
            return()
        )
        
        updateStatus "å¼€å§‹å¯¹é½åœ°é¢..."
        updateProgress 0
        
        addLog "æ‰§è¡Œåœ°é¢å¯¹é½åŠŸèƒ½ - å°†å·²ç»é€‰æ‹©çš„æ¨¡å‹å¯¹é½åˆ°åœ°å½¢é˜Ÿåˆ—ä¸­çš„åœ°å½¢æ¨¡å‹ä¸Š"
        
        -- æ¨¡æ‹Ÿå¤„ç†è¿‡ç¨‹
        local targetTerrain = terrainQueue[1] -- ä½¿ç”¨ç¬¬ä¸€ä¸ªåœ°å½¢ä½œä¸ºç›®æ ‡
        for i = 1 to buildingQueue.count do
        (
            local obj = buildingQueue[i]
            if isValidNode obj then
            (
                addLog ("æ­£åœ¨å¯¹é½æ¨¡å‹: " + obj.name + " åˆ°åœ°å½¢: " + targetTerrain.name)
                updateProgress (i as float / buildingQueue.count * 100)
                -- è¿™é‡Œè°ƒç”¨å®é™…çš„å¯¹é½å‡½æ•°
                -- alignToSurface obj targetTerrain
            )
            windows.processPostedMessages()
        )
        
        updateProgress 100
        updateStatus "åœ°é¢å¯¹é½å®Œæˆ"
    )
    
    on btnMergeModel pressed do
    (
        if buildingQueue.count == 0 then
        (
            messageBox "å»ºç­‘æ¨¡å‹é˜Ÿåˆ—ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å»ºç­‘æ¨¡å‹" title:"è­¦å‘Š"
            return()
        )
        
        updateStatus "å¼€å§‹åˆå¹¶æ¨¡å‹..."
        updateProgress 0
        
        addLog "æ‰§è¡Œæ¨¡å‹åˆå¹¶åŠŸèƒ½ - å¯¹é€‰æ‹©çš„æ¨¡å‹è¿›è¡Œåˆå¹¶"
        
        -- æ¨¡æ‹Ÿå¤„ç†è¿‡ç¨‹
        addLog ("æ­£åœ¨åˆå¹¶ " + buildingQueue.count as string + " ä¸ªæ¨¡å‹...")
        updateProgress 50
        
        -- è¿™é‡Œè°ƒç”¨å®é™…çš„åˆå¹¶å‡½æ•°
        -- local mergedModel = mergeElements buildingQueue
        
        updateProgress 100
        updateStatus "æ¨¡å‹åˆå¹¶å®Œæˆ"
        addLog "åˆå¹¶å®Œæˆï¼Œç”Ÿæˆç»Ÿä¸€çš„è¿œæ™¯å»ºç­‘æ¨¡å‹"
    )
    
    -- ä¸€é”®å¤„ç†æŒ‰é’®äº‹ä»¶
    on btnOneClickProcess pressed do
    (
        if buildingQueue.count == 0 then
        (
            messageBox "å»ºç­‘æ¨¡å‹é˜Ÿåˆ—ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å»ºç­‘æ¨¡å‹" title:"è­¦å‘Š"
            return()
        )
        
        if terrainQueue.count == 0 then
        (
            messageBox "åœ°å½¢é˜Ÿåˆ—ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ åœ°å½¢æ¨¡å‹" title:"è­¦å‘Š"
            return()
        )
        
        -- ä¼°ç®—å¤„ç†æ—¶é—´
        updateStatus "æ­£åœ¨ä¼°ç®—å¤„ç†æ—¶é—´..."
        local timeEstimate = estimateProcessingTime buildingQueue
        local timeString = formatTimeString timeEstimate.estimatedTimeSeconds
        
        -- æ˜¾ç¤ºä¼°ç®—ä¿¡æ¯å¹¶è¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­
        local infoMsg = "å¤„ç†æ—¶é—´ä¼°ç®—:\n"
        infoMsg += "- æ€»é¢æ•°: " + timeEstimate.totalFaces as string + "\n"
        infoMsg += "- å®é™…å…ƒç´ æ•°: " + timeEstimate.estimatedElements as string + "\n"
        infoMsg += "- é¢„è®¡å¤„ç†æ—¶é—´: " + timeString + "\n\n"
        infoMsg += "æ˜¯å¦å¼€å§‹ä¸€é”®å¤„ç†æµç¨‹?"
        
        local continueProcessing = queryBox infoMsg title:"å¤„ç†æ—¶é—´ä¼°ç®—"
        if not continueProcessing then (
            updateStatus "ç”¨æˆ·å–æ¶ˆäº†å¤„ç†"
            return()
        )
        
        isProcessing = true
        updateStatus "å¼€å§‹ä¸€é”®å¤„ç†æµç¨‹..."
        addLog "=== å¼€å§‹ä¸€é”®å¤„ç†ï¼šåˆ†ç¦»æ¨¡å‹ â†’ å¯¹é½åœ°é¢ â†’ åˆå¹¶æ¨¡å‹ ==="
        addLog ("é¢„è®¡å¤„ç†æ—¶é—´: " + timeString)
        
        try
        (
            -- æ­¥éª¤1ï¼šåˆ†ç¦»æ¨¡å‹
            updateStatus "æ­¥éª¤1/3: åˆ†ç¦»æ¨¡å‹"
            addLog "æ­¥éª¤1: æ‰§è¡Œæ¨¡å‹åˆ†ç¦»"
            updateProgress 10
            
            -- ä¼°ç®—å¤„ç†æ—¶é—´
            local timeEstimate = estimateProcessingTime buildingQueue
            local allSeparatedElements = #()
            
            for i = 1 to buildingQueue.count do
            (
                local obj = buildingQueue[i]
                if isValidNode obj then
                (
                    local objName = obj.name
                    
                    -- æ­¥éª¤1: å…ˆä¸ºæ¨¡å‹åˆ›å»ºåŒåå±‚å¹¶å°†åŸå§‹æ¨¡å‹æ·»åŠ åˆ°å±‚ä¸­
                    addLog ("æ­£åœ¨ä¸ºæ¨¡å‹ " + objName + " åˆ›å»ºå±‚...")
                    try (
                        -- åˆ›å»ºä¸æ¨¡å‹åŒåçš„å±‚
                        local modelLayer
                        if (layerManager.getLayerFromName objName) == undefined then
                        (
                            modelLayer = layerManager.newLayerFromName objName
                        )
                        else
                        (
                            modelLayer = layerManager.getLayerFromName objName
                        )
                        
                        -- å°†åŸå§‹æ¨¡å‹æ·»åŠ åˆ°å±‚ä¸­
                        modelLayer.addNode obj
                        
                        addLog ("å·²å°†æ¨¡å‹ " + objName + " æ·»åŠ åˆ°åŒåå±‚ä¸­")
                    ) catch (
                        addLog ("åˆ›å»ºå±‚æˆ–æ·»åŠ æ¨¡å‹åˆ°å±‚æ—¶å‡ºé”™: " + (getCurrentException()))
                    )
                    
                    -- æ­¥éª¤2: åœ¨å±‚å†…åˆ†ç¦»æ¨¡å‹
                    addLog ("æ­£åœ¨åˆ†ç¦»æ¨¡å‹: " + objName)
                    updateProgress (10 + i as float / buildingQueue.count * 30)
                    
                    -- è°ƒç”¨å®é™…çš„åˆ†ç¦»å‡½æ•°
                    local separatedElements = decomposeModel obj timeEstimate:timeEstimate
                    
                    -- å¤„ç†åˆ†ç¦»ç»“æœ
                    if separatedElements.count > 0 then
                    (
                        -- å°†åˆ†ç¦»çš„å…ƒç´ æ·»åŠ åˆ°æ€»å…ƒç´ åˆ—è¡¨ä¸­
                        join allSeparatedElements separatedElements
                        
                        -- ç¡®ä¿æ‰€æœ‰åˆ†ç¦»å…ƒç´ éƒ½åœ¨æ­£ç¡®çš„å±‚ä¸­
                        try (
                            -- è·å–å·²åˆ›å»ºçš„å±‚å¼•ç”¨
                            local modelLayer = layerManager.getLayerFromName objName
                            if modelLayer != undefined then
                            (
                                -- æ‰¹é‡æ·»åŠ æ‰€æœ‰å…ƒç´ åˆ°å±‚
                                for elem in separatedElements do
                                (
                                    modelLayer.addNode elem
                                )
                                addLog ("æˆåŠŸä»æ¨¡å‹ " + objName + " åˆ†ç¦»å‡º " + separatedElements.count as string + " ä¸ªå…ƒç´ å¹¶æ·»åŠ åˆ°å±‚ '" + objName + "'")
                            )
                            else
                            (
                                addLog ("è­¦å‘Š: æœªæ‰¾åˆ°å±‚ '" + objName + "', æ— æ³•æ·»åŠ åˆ†ç¦»å…ƒç´ ")
                            )
                        ) catch (
                            addLog ("å°†åˆ†ç¦»å…ƒç´ æ·»åŠ åˆ°å±‚æ—¶å‡ºé”™: " + (getCurrentException()))
                        )
                    )
                    else
                    (
                        addLog ("åˆ†ç¦»æ¨¡å‹ " + objName + " å¤±è´¥æˆ–æœªæ‰¾åˆ°å¯åˆ†ç¦»å…ƒç´ ")
                    )
                )
                windows.processPostedMessages()
            )
            
            -- æ­¥éª¤2ï¼šå¯¹é½åœ°é¢
            updateStatus "æ­¥éª¤2/3: å¯¹é½åœ°é¢"
            addLog "æ­¥éª¤2: æ‰§è¡Œåœ°é¢å¯¹é½"
            updateProgress 40
            
            local targetTerrain = terrainQueue[1]
            for i = 1 to buildingQueue.count do
            (
                local obj = buildingQueue[i]
                if isValidNode obj then
                (
                    addLog ("å¯¹é½æ¨¡å‹: " + obj.name + " åˆ°åœ°å½¢: " + targetTerrain.name)
                    updateProgress (40 + i as float / buildingQueue.count * 30)
                )
                windows.processPostedMessages()
            )
            
            -- æ­¥éª¤3ï¼šåˆå¹¶æ¨¡å‹
            updateStatus "æ­¥éª¤3/3: åˆå¹¶æ¨¡å‹"
            addLog "æ­¥éª¤3: æ‰§è¡Œæ¨¡å‹åˆå¹¶"
            updateProgress 70
            
            addLog ("åˆå¹¶ " + buildingQueue.count as string + " ä¸ªå¤„ç†åçš„æ¨¡å‹")
            updateProgress 90
            
            -- å®Œæˆ
            updateProgress 100
            updateStatus "ä¸€é”®å¤„ç†å®Œæˆï¼"
            addLog "=== ä¸€é”®å¤„ç†æµç¨‹å®Œæˆ ==="
            addLog "æˆåŠŸç”Ÿæˆè¿œæ™¯å»ºç­‘æ¨¡å‹"
            
            messageBox "ä¸€é”®å¤„ç†å®Œæˆï¼\n\nå·²å®Œæˆï¼š\n1. æ¨¡å‹åˆ†ç¦»\n2. åœ°é¢å¯¹é½\n3. æ¨¡å‹åˆå¹¶\n\nè¯·æŸ¥çœ‹è¿è¡Œæ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚" title:"å¤„ç†å®Œæˆ"
        )
        catch
        (
            updateStatus "å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"
            addLog ("é”™è¯¯: " + getCurrentException())
            messageBox "å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹è¿è¡Œæ—¥å¿—" title:"é”™è¯¯"
        )
        
        isProcessing = false
    )
    
    -- ç•Œé¢åˆå§‹åŒ–
    on DistantArchitectureUI open do
    (
        -- è®¾ç½®RichTextBoxå±æ€§
        edtLog.ReadOnly = true
        edtLog.BackColor = (dotNetClass "System.Drawing.Color").FromArgb 180 180 180
        edtLog.Font = dotNetObject "System.Drawing.Font" "Consolas" 9
        edtLog.WordWrap = true
        edtLog.ScrollBars = (dotNetClass "System.Windows.Forms.RichTextBoxScrollBars").Vertical
        
        addLog "è¿œæ™¯å»ºç­‘å¤„ç†å·¥å…·å·²å¯åŠ¨"
        addLog "è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š"
        addLog "1. ç‚¹å‡»'è·å–å»ºç­‘æ¨¡å‹'æ·»åŠ è¦å¤„ç†çš„å»ºç­‘æ¨¡å‹"
        addLog "2. ç‚¹å‡»'è·å–åœ°å½¢'æ·»åŠ åœ°å½¢æ¨¡å‹"
        addLog "3. å¯ä»¥ä½¿ç”¨ç‹¬ç«‹åŠŸèƒ½æŒ‰é’®åˆ†æ­¥å¤„ç†ï¼Œæˆ–ç‚¹å‡»'ä¸€é”®å¤„ç†'è‡ªåŠ¨å®Œæˆå…¨æµç¨‹"
        addLog "æ³¨æ„: å·²æ·»åŠ åˆ°å»ºç­‘é˜Ÿåˆ—çš„æ¨¡å‹ä¸èƒ½å†æ·»åŠ åˆ°åœ°å½¢é˜Ÿåˆ—"
        updateStatus "å·¥å…·å·²å°±ç»ªï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ"
    )
)

-- åˆ›å»ºè‡ªå®šä¹‰å¯¹è±¡é€‰æ‹©å¯¹è¯æ¡†
function createObjectSelector = 
(
    rollout objectSelectorRollout "é€‰æ‹©å»ºç­‘æ¨¡å‹" width:300 height:400
    (
        listbox objList "åœºæ™¯å¯¹è±¡:" height:15
        button btnOK "ç¡®å®š" width:80 height:25 pos:[110,350]
        button btnCancel "å–æ¶ˆ" width:80 height:25 pos:[200,350]
        
        local selectedObjects = #()
        
        on objectSelectorRollout open do
        (
            local objectNames = #()
            for obj in geometry do
                append objectNames obj.name
            objList.items = objectNames
        )
        
        on objList selectionEnd do
        (
            selectedObjects = #()
            for i in objList.selection do
            (
                if i > 0 and i <= geometry.count then
                    append selectedObjects geometry[i]
            )
        )
        
        on btnOK pressed do
        (
            destroyDialog objectSelectorRollout
            -- è¿”å›é€‰ä¸­çš„å¯¹è±¡
            selectedObjects
        )
        
        on btnCancel pressed do
        (
            destroyDialog objectSelectorRollout
            #()
        )
    )
    
    createDialog objectSelectorRollout modal:true
)

-- åˆ›å»ºå¹¶æ˜¾ç¤ºå¯¹è¯æ¡†
createDialog DistantArchitectureUI
